CockroachDB - это (гео)распределенная, расширяемая РСУБД
## Query optimizer

Изначально был эвристический планировщик с простыми правилами. Затем правила стали немного сложнее. Это работало для OLTP нагрузок, но нагрузка была разная.

Cost-based планировщик пришел позже.

Использует Cascades-like архитектуру, но в отличие от стандартного Cascades учитывает распределенность СУБД при оценке стоимости (shared-nothing архитектура).

Этапы работы:
1. Parse - парсинг запроса в синтаксическое дерево
2. Optbuild - биндинг на системный каталог, семантический анализ, проверка прав доступа
3. Normalize - упрощение и нормализация запроса без учета стоимости, т.е. переписывание запроса (predicate pushdown и subquery decorrelation не всегда улучшают стоимость плана, но очень часто, чтобы не задумываться)
	1. Constant folding
	2. Eliminate unnecessary operations
	3. Canonicalize expressions
	4. Predicate pushdown
	5. Subquery Decorrelation
4. Explore - этап работы Cascades с созданием альтернативных планов запроса
	1. Memo table также хранит скалярные выражения
5. DistSQL Planning - преобразует single-node план (что дал планировщик) в распределенный план

Для Cascades используется свой DSL - Optgen.

Join enumeration:
1. В первой версии не было алгоритма перебора JOIN'ов
2. Затем добавили 2 правила: Коммутативное и Ассоциативное
3. Сейчас используется DPsube алгоритм ([ссылка на статью](https://www.researchgate.net/publication/262216932_On_the_correct_and_complete_enumeration_of_the_core_search_space))
## Статистика

Расчет стоимости для распределенных вычислений полагается на разные параметры:
1. Железо
2. Распределение данных
3. Физические операторы
4. Кардинальность оператора

Сбор статистики:
- Размер таблицы/индекса
- NDV (Number of Distinct Values)
- Количество NULL
- Гистограммы
- Multi-Column Statistics

При планировании учитывается расположение данных - предпочтение (стоимость ниже) отдается операторам, которые работают с локальными данными, без отправки на другие узлы (тем более континенты).

## Оптимизации

CockroachDB нацелен на OLTP нагрузку и многие части проектировались соответственно.

Примеры:
- Много правил нормализации - 242 - чем exploration - 29.
- Проверки на FOREIGN KEY

Есть хинты планировщика - можно сразу указывать алгоритм JOIN в SQL (изменен синтаксис) - `INNER HASH JOIN`.

## Отладка

Имеется специальная опция `EXPLAIN (DEBUG)` - создает множество файлов, которые могут помочь отла

## Полезные идеи

1. Можно использовать Cascades (Top-Down) вместе с Bottom-up алгоритмом Join (DPsube)

## Источники
1. [CockroachDB's Query Optimizer (Rebecca Taft, Cockroach Labs)](https://www.youtube.com/watch?v=wHo-VtzTHx0)